#include "../Include/nrf8001_api.h"
#include "../Include/SPI_api.h"
#include "../Include/UART_api.h"

void nrf_wait_for_rdy(void) {
	while((NRF_PIN & (1<<NRF_RDY)) !=0);
}

void nrf_send_packet(uint8_t *packet) {
	uint8_t length = (*packet) +1;
	NRF_START_TRANSMISSION;
	nrf_wait_for_rdy();

	spi_tranceive(packet, length);

	NRF_END_TRANSMISSION;
}

void nrf_receive_packet(void) {
	uint8_t nrf_data = 0;
	uint8_t nrf_packet_len = 0;
	uint8_t index;
	NRF_START_TRANSMISSION;
	nrf_wait_for_rdy();
	// first byte is nrf debugging byte...
	spi_receive();
	// second byte of packet - packet length (length packet excluded)
	nrf_packet_len = spi_receive();
	uart_print(&nrf_packet_len, 1);
	// trailing data
	for(index=0; index<nrf_packet_len; index++) {
		nrf_data = spi_receive();
		uart_print(&nrf_data, 1);
	}
	uart_println((uint8_t *) "", 0);
	NRF_END_TRANSMISSION;
}

void nrf_send_setup_data(void) {
	uint8_t index;
	uint8_t setup_data[NB_SETUP_MESSAGES][SETUP_PACKET_LENGTH] = {
		{0x07,0x06,0x00,0x00,0x03,0x02,0x41,0xd7,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
		{0x1f,0x06,0x10,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x04,0x00,0x04,0x01,0x01,0x00,0x00,0x06,0x00,0x00,0x90,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
		{0x1f,0x06,0x10,0x1c,0x01,0x02,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x14,0x00,0x00,0x00,0x14,0x03,0x90,0x01,0x64},
		{0x1f,0x06,0x10,0x38,0x02,0xff,0x02,0x58,0x00,0x05,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
		{0x05,0x06,0x10,0x54,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
		{0x1f,0x06,0x20,0x00,0x04,0x04,0x02,0x02,0x00,0x01,0x28,0x00,0x01,0x00,0x18,0x04,0x04,0x05,0x05,0x00,0x02,0x28,0x03,0x01,0x0e,0x03,0x00,0x00,0x2a,0x04,0x14,0x07},
		{0x1f,0x06,0x20,0x1c,0x04,0x00,0x03,0x2a,0x00,0x01,0x55,0x41,0x52,0x54,0x69,0x63,0x73,0x04,0x04,0x05,0x05,0x00,0x04,0x28,0x03,0x01,0x02,0x05,0x00,0x01,0x2a,0x06},
		{0x1f,0x06,0x20,0x38,0x04,0x03,0x02,0x00,0x05,0x2a,0x01,0x01,0x00,0x00,0x04,0x04,0x05,0x05,0x00,0x06,0x28,0x03,0x01,0x02,0x07,0x00,0x04,0x2a,0x06,0x04,0x09,0x08},
		{0x1f,0x06,0x20,0x54,0x00,0x07,0x2a,0x04,0x01,0x06,0x00,0x12,0x00,0x00,0x00,0x0a,0x00,0x04,0x04,0x02,0x02,0x00,0x08,0x28,0x00,0x01,0x01,0x18,0x04,0x04,0x10,0x10},
		{0x1f,0x06,0x20,0x70,0x00,0x09,0x28,0x00,0x01,0x9e,0xca,0xdc,0x24,0x0e,0xe5,0xa9,0xe0,0x93,0xf3,0xa3,0xb5,0x01,0x00,0x40,0x6e,0x04,0x04,0x13,0x13,0x00,0x0a,0x28},
		{0x1f,0x06,0x20,0x8c,0x03,0x01,0x04,0x0b,0x00,0x9e,0xca,0xdc,0x24,0x0e,0xe5,0xa9,0xe0,0x93,0xf3,0xa3,0xb5,0x02,0x00,0x40,0x6e,0x44,0x10,0x14,0x00,0x00,0x0b,0x00},
		{0x1f,0x06,0x20,0xa8,0x02,0x02,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x04,0x04,0x13,0x13,0x00,0x0c},
		{0x1f,0x06,0x20,0xc4,0x28,0x03,0x01,0x10,0x0d,0x00,0x9e,0xca,0xdc,0x24,0x0e,0xe5,0xa9,0xe0,0x93,0xf3,0xa3,0xb5,0x03,0x00,0x40,0x6e,0x14,0x00,0x14,0x00,0x00,0x0d},
		{0x1f,0x06,0x20,0xe0,0x00,0x03,0x02,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x46,0x14,0x03,0x02,0x00},
		{0x1f,0x06,0x20,0xfc,0x0e,0x29,0x02,0x01,0x00,0x00,0x04,0x04,0x02,0x02,0x00,0x0f,0x28,0x00,0x01,0x0a,0x18,0x04,0x04,0x05,0x05,0x00,0x10,0x28,0x03,0x01,0x02,0x11},
		{0x19,0x06,0x21,0x18,0x00,0x27,0x2a,0x04,0x04,0x09,0x01,0x00,0x11,0x2a,0x27,0x01,0x0a,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
		{0x1f,0x06,0x40,0x00,0x2a,0x00,0x01,0x00,0x80,0x04,0x00,0x03,0x00,0x00,0x00,0x02,0x02,0x00,0x08,0x04,0x00,0x0b,0x00,0x00,0x00,0x03,0x02,0x00,0x02,0x04,0x00,0x0d},
		{0x0f,0x06,0x40,0x1c,0x00,0x0e,0x2a,0x27,0x01,0x00,0x80,0x04,0x00,0x11,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
		{0x13,0x06,0x50,0x00,0x9e,0xca,0xdc,0x24,0x0e,0xe5,0xa9,0xe0,0x93,0xf3,0xa3,0xb5,0x00,0x00,0x40,0x6e,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
		{0x0f,0x06,0x60,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
		{0x06,0x06,0xf0,0x00,0x03,0xd3,0x88,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00}
	};
	for (index=0; index<NB_SETUP_MESSAGES; index++) {
		nrf_send_packet(setup_data[index]);
		nrf_wait_for_rdy();
		// recieve acknowledge
		nrf_receive_packet();
	}
}

void nrf_setup(void) {
	// wait till nrf wants to send shit
	nrf_wait_for_rdy();
	// send word that nrf wants to send shit
	// this usually the device started packet
	uart_println((uint8_t *) "DeviceStartedEvent", 18);
	nrf_wait_for_rdy();
	nrf_receive_packet();
	uart_println((uint8_t *) "SetupData start", 15);
	nrf_send_setup_data();
	uart_println((uint8_t *) "SetupData sent", 14);
	// recieve transaction complete packet
	// nrf_wait_for_rdy();
	// nrf_receive_packet();
	// recieve device in standby event
	nrf_wait_for_rdy();
	nrf_receive_packet();
	
	// start advertising
	nrf_advertise();
}

void nrf_advertise(void) {
	uint8_t packet[6];
	uart_println((uint8_t *) "Start adv", 9);
	packet[0] = 5;		// - len
	packet[1] = 0x0F;	// - connect command

	packet[2] = 0x00;	// - timeout
	packet[3] = 0x00;	// - timeout

	packet[4] = 100;	// - AdvInterval
	packet[5] = 0;	// - AdvInterval
	nrf_send_packet(packet);
	nrf_wait_for_rdy();
	nrf_receive_packet();
}